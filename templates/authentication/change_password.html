{% extends 'landingpage/base.html' %}
{% load static %}

{% block dashboard_content %}
<div class="max-w-2xl mx-auto">
  <!-- Navigation -->
  <div class="mb-6">
    <a href="{% url 'authentication:profile' %}" class="btn btn-ghost btn-sm">
      <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>
      Voltar ao Perfil
    </a>
  </div>

  <!-- Change Password Card -->
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <!-- Header -->
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto bg-warning/20 rounded-full flex items-center justify-center mb-4">
          <i data-lucide="key" class="w-8 h-8 text-warning"></i>
        </div>
        <h1 class="text-2xl font-bold">Alterar Senha</h1>
        <p class="text-base-content/70 mt-2">Digite sua senha atual e escolha uma nova senha segura</p>
      </div>

      <!-- Messages -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} mb-4">
            <i data-lucide="{% if message.tags == 'error' %}alert-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}alert-triangle{% else %}info{% endif %}" class="w-4 h-4"></i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Form -->
      <form method="post" class="space-y-6" id="change-password-form">
        {% csrf_token %}

        <!-- Current Password -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Senha Atual *</span>
          </label>
          <div class="relative">
            <input 
              type="password" 
              name="current_password" 
              class="input input-bordered w-full {% if form.current_password.errors %}input-error{% endif %}" 
              placeholder="Digite sua senha atual"
              required
              id="current-password"
            />
            <button 
              type="button" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center" 
              onclick="togglePassword('current-password', this)"
            >
              <i data-lucide="eye" class="w-4 h-4 text-base-content/50"></i>
            </button>
          </div>
          {% if form.current_password.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.current_password.errors.0 }}</span>
            </label>
          {% endif %}
        </div>

        <div class="divider"></div>

        <!-- New Password -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Nova Senha *</span>
          </label>
          <div class="relative">
            <input 
              type="password" 
              name="new_password1" 
              class="input input-bordered w-full {% if form.new_password1.errors %}input-error{% endif %}" 
              placeholder="Digite sua nova senha"
              required
              id="new-password1"
            />
            <button 
              type="button" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center" 
              onclick="togglePassword('new-password1', this)"
            >
              <i data-lucide="eye" class="w-4 h-4 text-base-content/50"></i>
            </button>
          </div>
          {% if form.new_password1.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.new_password1.errors.0 }}</span>
            </label>
          {% endif %}
        </div>

        <!-- Confirm New Password -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Confirmar Nova Senha *</span>
          </label>
          <div class="relative">
            <input 
              type="password" 
              name="new_password2" 
              class="input input-bordered w-full {% if form.new_password2.errors %}input-error{% endif %}" 
              placeholder="Confirme sua nova senha"
              required
              id="new-password2"
            />
            <button 
              type="button" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center" 
              onclick="togglePassword('new-password2', this)"
            >
              <i data-lucide="eye" class="w-4 h-4 text-base-content/50"></i>
            </button>
          </div>
          {% if form.new_password2.errors %}
            <label class="label">
              <span class="label-text-alt text-error">{{ form.new_password2.errors.0 }}</span>
            </label>
          {% endif %}
        </div>

        <!-- Password Requirements -->
        <div class="alert alert-info">
          <i data-lucide="info" class="w-4 h-4"></i>
          <div>
            <h4 class="font-bold">Requisitos da Senha:</h4>
            <ul class="list-disc list-inside text-sm mt-2 space-y-1">
              <li>Pelo menos 8 caracteres</li>
              <li>Não pode ser muito similar às suas informações pessoais</li>
              <li>Não pode ser uma senha muito comum</li>
              <li>Não pode ser inteiramente numérica</li>
            </ul>
          </div>
        </div>

        <!-- Password Strength Indicator -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Força da Senha</span>
          </label>
          <div class="flex space-x-1">
            <div class="flex-1 h-2 bg-base-300 rounded" id="strength-1"></div>
            <div class="flex-1 h-2 bg-base-300 rounded" id="strength-2"></div>
            <div class="flex-1 h-2 bg-base-300 rounded" id="strength-3"></div>
            <div class="flex-1 h-2 bg-base-300 rounded" id="strength-4"></div>
          </div>
          <label class="label">
            <span class="label-text-alt" id="strength-text">Digite uma senha para verificar sua força</span>
          </label>
        </div>

        <!-- Form Actions -->
        <div class="card-actions justify-end pt-4">
          <a href="{% url 'authentication:profile' %}" class="btn btn-ghost">
            Cancelar
          </a>
          <button type="submit" class="btn btn-warning">
            <i data-lucide="save" class="w-4 h-4 mr-1"></i>
            Alterar Senha
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript for password functionality -->
<script>
// Toggle password visibility
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
        lucide.createIcons();
    } else {
        input.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
        lucide.createIcons();
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) score++;
    else feedback.push('Pelo menos 8 caracteres');
    
    // Character variety
    if (/[a-z]/.test(password)) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    // Reduce score for common patterns
    if (/^[0-9]+$/.test(password)) score = Math.max(0, score - 2);
    if (/^[a-z]+$/.test(password)) score = Math.max(0, score - 1);
    
    return { score: Math.min(score, 4), feedback };
}

function updatePasswordStrength() {
    const password = document.getElementById('new-password1').value;
    const { score } = checkPasswordStrength(password);
    
    const strengthBars = [
        document.getElementById('strength-1'),
        document.getElementById('strength-2'),
        document.getElementById('strength-3'),
        document.getElementById('strength-4')
    ];
    
    const strengthText = document.getElementById('strength-text');
    
    // Reset all bars
    strengthBars.forEach(bar => {
        bar.className = 'flex-1 h-2 bg-base-300 rounded';
    });
    
    // Color bars based on strength
    const colors = ['bg-error', 'bg-warning', 'bg-info', 'bg-success'];
    const texts = ['Muito fraca', 'Fraca', 'Média', 'Forte'];
    
    if (password.length === 0) {
        strengthText.textContent = 'Digite uma senha para verificar sua força';
        return;
    }
    
    for (let i = 0; i < score; i++) {
        strengthBars[i].className = `flex-1 h-2 ${colors[score - 1]} rounded`;
    }
    
    strengthText.textContent = `Força da senha: ${texts[score - 1] || 'Muito fraca'}`;
}

// Add event listeners
document.getElementById('new-password1').addEventListener('input', updatePasswordStrength);

// Confirm password matching
document.getElementById('new-password2').addEventListener('input', function() {
    const password1 = document.getElementById('new-password1').value;
    const password2 = this.value;
    
    if (password2.length > 0) {
        if (password1 === password2) {
            this.classList.remove('input-error');
            this.classList.add('input-success');
        } else {
            this.classList.remove('input-success');
            this.classList.add('input-error');
        }
    } else {
        this.classList.remove('input-error', 'input-success');
    }
});

// Form validation
document.getElementById('change-password-form').addEventListener('submit', function(e) {
    const password1 = document.getElementById('new-password1').value;
    const password2 = document.getElementById('new-password2').value;
    
    if (password1 !== password2) {
        e.preventDefault();
        alert('As senhas não coincidem. Por favor, verifique e tente novamente.');
        return false;
    }
    
    if (password1.length < 8) {
        e.preventDefault();
        alert('A nova senha deve ter pelo menos 8 caracteres.');
        return false;
    }
});
</script>
{% endblock %}
