{% extends 'finance_manager/base.html' %}
{% load static %}
{% load mathfilters %}

{% block finance_head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/finance_dashboard.css' %}">
<script>

  // Set URLs and CSRF token for JavaScript to use
  window.createExpenseUrl = '{% url "finance_manager:create_expense" %}';
  window.createCategoryUrl = '{% url "finance_manager:create_category" %}';
  window.createIncomeUrl = '{% url "finance_manager:create_income" %}';     
  window.createIncomeCategoryUrl = '{% url "finance_manager:create_income_category" %}';
  window.editExpenseUrl = '/finance/expense/'; // Will append ID in JavaScript
  window.deleteExpenseUrl = '/finance/expense/'; // Will append ID in JavaScript
  window.editIncomeUrl = '/finance/income/'; // Will append ID in JavaScript
  window.deleteIncomeUrl = '/finance/income/'; // Will append ID in JavaScript
  window.importDataUrl = '{% url "finance_manager:import_data" %}';
  window.exportDataJsonUrl = '{% url "finance_manager:export_financial_data_json" %}'
  window.exportDataCsvUrl = '{% url "finance_manager:export_financial_data_csv" %}'
  window.exportDataExcelUrl = '{% url "finance_manager:export_financial_data_excel" %}'
  window.csrfToken = '{{ csrf_token }}';
</script>
{% endblock %}

{% block finance_content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-3xl font-bold text-base-content mb-2">
          <i data-lucide="credit-card" class="w-8 h-8 inline-block mr-3"></i>
          Gestão de Gastos
        </h1>
        <p class="text-base-content/70">Controle e monitore seus gastos pessoais</p>
      </div>
      <div class="flex gap-2">
        <button onclick="openImportModal()" class="btn btn-outline btn-sm">
          <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
          Importar Dados
        </button>
        <button onclick="openExportModal()" class="btn btn-outline btn-sm">
          <i data-lucide="download" class="w-4 h-4 mr-2"></i>
          Exportar Dados
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="stat bg-base-100 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer group" onclick="openExpenseModal()">
      <div class="stat-figure text-secondary">
        <i data-lucide="trending-down" class="w-8 h-8"></i>
      </div>
      <div class="stat-title">Gastos do Mês</div>
      <div class="stat-value text-secondary flex items-center gap-3">
        R$ {{total_expenses_this_month}}
        <div class="btn btn-circle btn-xs btn-secondary opacity-0 group-hover:opacity-100 transition-opacity">
          <i data-lucide="plus" class="w-5 h-5"></i>
        </div>
      </div>
      <div class="stat-desc">Agosto</div>
    </div>
    
    <div class="stat bg-base-100 rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer group" onclick="openIncomeModal()">
      <div class="stat-figure text-accent">
        <i data-lucide="target" class="w-8 h-8"></i>
      </div>
      <div class="stat-title">Saldo Total</div>
      <div class="stat-value text-accent flex items-center gap-3">
        R$ {{total_amount}}
        <div class="btn btn-circle btn-xs btn-accent opacity-0 group-hover:opacity-100 transition-opacity">
          <i data-lucide="plus" class="w-5 h-5"></i>
        </div>
      </div>
      <div class="stat-desc">Total acumulado</div>
    </div>
    
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-figure text-primary">
        <i data-lucide="calendar" class="w-8 h-8"></i>
      </div>
      <div class="stat-title">Média Diária de Gastos</div>
      <div class="stat-value text-primary">R$ {{ daily_mean }}</div>
      <div class="stat-desc">{{ range_of_days }}</div>
    </div>
  </div>

  <!-- Recent Expenses Preview -->
  <div class="mt-8">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <div class="flex justify-between items-center">
          <h2 class="card-title hover">
            <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
            Gastos Recentes
          </h2>
          <div class="btn btn-circle btn-xs btn-secondary" onclick="openExpenseModal()">
            <i data-lucide="plus" class="w-5 h-5"></i>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for expense in expenses %}
              <tr>
                <td>{{ expense.spent_at | date:"D, d M, Y" }}</td>
                <td>{{ expense.description }}</td>
                <td><span class="badge badge-primary border-hidden shadow-md opacity-80" style="background-color:{{ expense.category.color }}; important!">{{ expense.category.name }}</span></td>
                {% with am=expense.amount %}
                <td class="text-error font-semibold">R$ {{ am|intdiv:100 }}{% if am|mod:100 == 0 %},00{%elif am|mod:100 < 10%},0{{am|mod:100}}{% else %},{{am|mod:100}}{% endif %}</td>
                {% endwith %}
                <td>
                  <button class="btn btn-ghost btn-sm" onclick="openEditExpenseModal({{ expense.id }}, '{{ expense.description|escapejs }}', '{{ expense.detailed_description|escapejs }}', '{{ expense.spent_at|date:'Y-m-d' }}', {{ expense.amount }}, {{ expense.category.id }})">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="card-actions justify-end mt-4">
          <a href="{% url 'finance_manager:transactions' %}#expenses" class="btn btn-outline">Ver Todos os Gastos</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Incomes Preview -->
  <div class="mt-8">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <div class="flex justify-between items-center">
          <h2 class="card-title hover">
            <i data-lucide="clock" class="w-5 h-5 mr-2"></i>
            Receitas Recentes
          </h2>
          <div class="btn btn-circle btn-xs btn-accent" onclick="openExpenseModal()">
            <i data-lucide="plus" class="w-5 h-5"></i>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Valor</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for income in incomes %}
              <tr>
                <td>{{ income.received_at | date:"D, d M, Y" }}</td>
                <td>{{ income.description }}</td>
                <td>
                  {% if income.category %}
                    <span class="badge badge-secondary border-hidden shadow-md" style="background-color:{{ income.category.color }}; color: white;">{{ income.category.name }}</span>
                  {% else %}
                    <span class="badge badge-ghost">Sem categoria</span>
                  {% endif %}
                </td>
                {% with am=income.amount %}
                <td class="text-success font-semibold">R$ {{ am|intdiv:100 }}{% if am|mod:100 == 0 %},00{%elif am|mod:100 < 10%},0{{am|mod:100}}{% else %},{{am|mod:100}}{% endif %}</td>
                {% endwith %}
                <td>
                  <button class="btn btn-ghost btn-sm" onclick="openEditIncomeModal({{ income.id }}, '{{ income.description|escapejs }}', '{{ income.detailed_description|escapejs }}', '{{ income.received_at|date:'Y-m-d' }}', {{ income.amount }}, {% if income.category %}{{ income.category.id }}{% else %}null{% endif %})">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="card-actions justify-end mt-4">
          <a href="{% url 'finance_manager:transactions' %}#incomes" class="btn btn-outline">Ver Todas as Receitas</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Expense Modal -->
<div id="expenseModal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="plus" class="w-5 h-5 inline-block mr-2"></i>
      Adicionar Novo Gasto
    </h3>
    
    <form id="expenseForm" class="space-y-4">
      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição *</span>
        </label>
        <input type="text" id="description" name="description" placeholder="Ex: Supermercado, Gasolina..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Detailed Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição Detalhada</span>
        </label>
        <textarea id="detailed_description" name="detailed_description" 
                  placeholder="Informações adicionais sobre o gasto..." 
                  class="textarea textarea-bordered w-full h-20"></textarea>
      </div>
      
      <!-- Date and Amount Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Date -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Data do Gasto *</span>
          </label>
          <input type="date" id="spent_at" name="spent_at" 
                 class="input input-bordered w-full" required>
        </div>
        
        <!-- Amount -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Valor (R$) *</span>
          </label>
          <input type="number" id="amount" name="amount" step="0.01" min="0" 
                 placeholder="0,00" class="input input-bordered w-full" required>
        </div>
      </div>
      
      <!-- Category -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Categoria</span>
        </label>
        <div class="flex gap-2">
          <select id="category" name="category" class="select select-bordered flex-1">
            <option value="">Selecione uma categoria</option>
            {% for category in categories %}
              <option value="{{ category.id }}" data-color="{{ category.color }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline" onclick="openCategoryModal()">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeExpenseModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="submitExpense()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Salvar Gasto
      </button>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div id="categoryModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="tag" class="w-5 h-5 inline-block mr-2"></i>
      Nova Categoria
    </h3>
    
    <form id="categoryForm" class="space-y-4">
      <!-- Category Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Nome da Categoria *</span>
        </label>
        <input type="text" id="category_name" name="name" placeholder="Ex: Alimentação, Transporte..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Category Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição</span>
        </label>
        <input type="text" id="category_description" name="description" 
               placeholder="Descrição da categoria..." 
               class="input input-bordered w-full">
      </div>
      
      <!-- Category Color -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Cor da Categoria</span>
        </label>
        <div class="flex gap-2 items-center">
          <input type="color" id="category_color" name="color" value="#3B82F6" 
                 class="w-12 h-12 rounded-lg border-2 border-base-300">
          <span class="text-sm text-base-content/70">Escolha uma cor para identificar a categoria</span>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeCategoryModal()">Cancelar</button>
      <button id="deleteCategoryBtn" class="btn btn-error" onclick="deleteCategory()" style="display: none;">
        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
        Excluir Categoria
      </button>
      <button class="btn btn-primary" onclick="submitCategory()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Criar Categoria
      </button>
    </div>
  </div>
</div>

<!-- Edit Expense Modal -->
<div id="editExpenseModal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="pencil" class="w-5 h-5 inline-block mr-2"></i>
      Editar Gasto
    </h3>
    
    <form id="editExpenseForm" class="space-y-4">
      <input type="hidden" id="edit_expense_id" name="expense_id">
      
      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição *</span>
        </label>
        <input type="text" id="edit_description" name="description" placeholder="Ex: Supermercado, Gasolina..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Detailed Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição Detalhada</span>
        </label>
        <textarea id="edit_detailed_description" name="detailed_description" 
                  placeholder="Informações adicionais sobre o gasto..." 
                  class="textarea textarea-bordered w-full h-20"></textarea>
      </div>
      
      <!-- Date and Amount Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Date -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Data do Gasto *</span>
          </label>
          <input type="date" id="edit_spent_at" name="spent_at" 
                 class="input input-bordered w-full" required>
        </div>
        
        <!-- Amount -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Valor (R$) *</span>
          </label>
          <input type="number" id="edit_amount" name="amount" step="0.01" min="0" 
                 placeholder="0,00" class="input input-bordered w-full" required>
        </div>
      </div>
      
      <!-- Category -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Categoria</span>
        </label>
        <div class="flex gap-2">
          <select id="edit_category" name="category" class="select select-bordered flex-1">
            <option value="">Selecione uma categoria</option>
            {% for category in categories %}
              <option value="{{ category.id }}" data-color="{{ category.color }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline" onclick="editSelectedCategory()">
            <i data-lucide="pencil" class="w-4 h-4"></i>
          </button>
          <button type="button" class="btn btn-outline" onclick="openCategoryModal()">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeEditExpenseModal()">Cancelar</button>
      <button class="btn btn-error btn-outline" onclick="deleteExpense()">
        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
        Excluir
      </button>
      <button class="btn btn-primary" onclick="submitEditExpense()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Salvar Alterações
      </button>
    </div>
  </div>
</div>

<!-- Add Income Modal -->
<div id="incomeModal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="plus" class="w-5 h-5 inline-block mr-2"></i>
      Adicionar Nova Receita
    </h3>
    
    <form id="incomeForm" class="space-y-4">
      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição *</span>
        </label>
        <input type="text" id="income_description" name="description" placeholder="Ex: Salário, Freelance..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Detailed Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição Detalhada</span>
        </label>
        <textarea id="income_detailed_description" name="detailed_description" 
                  placeholder="Informações adicionais sobre a receita..." 
                  class="textarea textarea-bordered w-full h-20"></textarea>
      </div>
      
      <!-- Date and Amount Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Date -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Data do Recebimento *</span>
          </label>
          <input type="date" id="income_received_at" name="received_at" 
                 class="input input-bordered w-full" required>
        </div>
        
        <!-- Amount -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Valor (R$) *</span>
          </label>
          <input type="number" id="income_amount" name="amount" step="0.01" min="0" 
                 placeholder="0,00" class="input input-bordered w-full" required>
        </div>
      </div>
      
      <!-- Category -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Categoria</span>
        </label>
        <div class="flex gap-2">
          <select id="income_category" name="category" class="select select-bordered flex-1">
            <option value="">Selecione uma categoria</option>
            {% for category in income_categories %}
              <option value="{{ category.id }}" data-color="{{ category.color }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline" onclick="openIncomeCategoryModal()">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeIncomeModal()">Cancelar</button>
      <button class="btn btn-secondary" onclick="submitIncome()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Salvar Receita
      </button>
    </div>
  </div>
</div>

<!-- Add Income Category Modal -->
<div id="incomeCategoryModal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="tag" class="w-5 h-5 inline-block mr-2"></i>
      Nova Categoria de Receita
    </h3>
    
    <form id="incomeCategoryForm" class="space-y-4">
      <!-- Category Name -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Nome da Categoria *</span>
        </label>
        <input type="text" id="income_category_name" name="name" placeholder="Ex: Salário, Investimentos..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Category Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição</span>
        </label>
        <input type="text" id="income_category_description" name="description" 
               placeholder="Descrição da categoria..." 
               class="input input-bordered w-full">
      </div>
      
      <!-- Category Color -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Cor da Categoria</span>
        </label>
        <div class="flex gap-2 items-center">
          <input type="color" id="income_category_color" name="color" value="#10B981" 
                 class="w-12 h-12 rounded-lg border-2 border-base-300">
          <span class="text-sm text-base-content/70">Escolha uma cor para identificar a categoria</span>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeIncomeCategoryModal()">Cancelar</button>
      <button id="deleteIncomeCategoryBtn" class="btn btn-error" onclick="deleteIncomeCategory()" style="display: none;">
        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
        Excluir Categoria
      </button>
      <button class="btn btn-secondary" onclick="submitIncomeCategory()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Criar Categoria
      </button>
    </div>
  </div>
</div>

<!-- Edit Income Modal -->
<div id="editIncomeModal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">
      <i data-lucide="pencil" class="w-5 h-5 inline-block mr-2"></i>
      Editar Receita
    </h3>
    
    <form id="editIncomeForm" class="space-y-4">
      <input type="hidden" id="edit_income_id" name="income_id">
      
      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição *</span>
        </label>
        <input type="text" id="edit_income_description" name="description" placeholder="Ex: Salário, Freelance..." 
               class="input input-bordered w-full" required>
      </div>
      
      <!-- Detailed Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Descrição Detalhada</span>
        </label>
        <textarea id="edit_income_detailed_description" name="detailed_description" 
                  placeholder="Informações adicionais sobre a receita..." 
                  class="textarea textarea-bordered w-full h-20"></textarea>
      </div>
      
      <!-- Date and Amount Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Date -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Data do Recebimento *</span>
          </label>
          <input type="date" id="edit_income_received_at" name="received_at" 
                 class="input input-bordered w-full" required>
        </div>
        
        <!-- Amount -->
        <div class="form-control">
          <label class="label">
            <span class="label-text">Valor (R$) *</span>
          </label>
          <input type="number" id="edit_income_amount" name="amount" step="0.01" min="0" 
                 placeholder="0,00" class="input input-bordered w-full" required>
        </div>
      </div>
      
      <!-- Category -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Categoria</span>
        </label>
        <div class="flex gap-2">
          <select id="edit_income_category" name="category" class="select select-bordered flex-1">
            <option value="">Selecione uma categoria</option>
            {% for category in income_categories %}
              <option value="{{ category.id }}" data-color="{{ category.color }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-outline" onclick="editSelectedIncomeCategory()" title="Editar categoria selecionada">
            <i data-lucide="pencil" class="w-4 h-4"></i>
          </button>
          <button type="button" class="btn btn-outline" onclick="openIncomeCategoryModal()">
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button class="btn" onclick="closeEditIncomeModal()">Cancelar</button>
      <button class="btn btn-error btn-outline" onclick="deleteIncome()">
        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
        Excluir
      </button>
      <button class="btn btn-secondary" onclick="submitEditIncome()">
        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
        Salvar Alterações
      </button>
    </div>
  </div>
</div>

<!-- Import Data Modal -->
<div id="importModal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">
      <i data-lucide="upload" class="w-5 h-5 inline-block mr-2"></i>
      Importar Dados Financeiros
    </h3>
    
    <div class="space-y-4">
      <!-- File Upload Area -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Arquivo de Dados</span>
        </label>
        <div class="flex items-center justify-center w-full">
          <label for="import-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <i data-lucide="upload-cloud" class="w-8 h-8 mb-3 text-gray-400"></i>
              <p class="mb-2 text-sm text-gray-500">
                <span class="font-semibold">Clique para enviar</span> ou arraste e solte
              </p>
              <p class="text-xs text-gray-500">JSON, CSV ou Excel (máx. 10MB)</p>
            </div>
            <input id="import-file" type="file" class="hidden" accept=".json,.csv,.xlsx,.xls" onchange="handleFileSelect(event)" />
          </label>
        </div>
        <div id="file-info" class="mt-2 text-sm text-gray-600 hidden"></div>
      </div>

      <!-- Options -->
      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text">Limpar dados existentes antes da importação</span>
          <input id="clear-existing" type="checkbox" class="checkbox checkbox-warning" />
        </label>
        <div class="text-xs text-gray-500 mt-1">
          ⚠️ Esta opção irá remover todos os seus dados atuais antes de importar os novos dados
        </div>
      </div>

      <!-- Preview Area -->
      <div id="import-preview" class="bg-base-200 rounded-lg p-4 hidden">
        <h4 class="font-semibold mb-2">Prévia dos dados:</h4>
        <div id="preview-content" class="text-sm"></div>
      </div>

      <!-- Progress Area -->
      <div id="import-progress" class="hidden">
        <div class="flex items-center space-x-2">
          <div class="loading loading-spinner loading-sm"></div>
          <span>Importando dados...</span>
        </div>
      </div>
    </div>

    <div class="modal-action">
      <button class="btn" onclick="closeImportModal()">Cancelar</button>
      <button id="import-btn" class="btn btn-primary" onclick="submitImport()" disabled>
        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
        Importar Dados
      </button>
    </div>
  </div>
</div>

<!-- Export Format Selection Modal -->
<div id="exportModal" class="modal">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">
      <i data-lucide="download" class="w-5 h-5 inline-block mr-2"></i>
      Exportar Dados Financeiros
    </h3>
    
    <div class="space-y-4">
      <p class="text-base-content/70">Selecione o formato para exportar seus dados:</p>
      
      <!-- Export Format Options -->
      <div class="space-y-3">
        <!-- JSON Option -->
        <label class="flex items-center p-4 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200 transition-colors">
          <input type="radio" name="export-format" value="json" class="radio radio-primary mr-4" checked>
          <div class="flex-1">
            <div class="flex items-center">
              <i data-lucide="file-text" class="w-5 h-5 mr-2 text-primary"></i>
              <span class="font-semibold">JSON</span>
            </div>
            <p class="text-sm text-base-content/70 mt-1">
              Formato estruturado ideal para backup e reimportação completa dos dados
            </p>
          </div>
        </label>

        <!-- CSV Option -->
        <label class="flex items-center p-4 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200 transition-colors">
          <input type="radio" name="export-format" value="csv" class="radio radio-primary mr-4">
          <div class="flex-1">
            <div class="flex items-center">
              <i data-lucide="table" class="w-5 h-5 mr-2 text-success"></i>
              <span class="font-semibold">CSV</span>
            </div>
            <p class="text-sm text-base-content/70 mt-1">
              Formato de planilha compatível com Excel, Google Sheets e outros
            </p>
          </div>
        </label>

        <!-- Excel Option -->
        <label class="flex items-center p-4 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200 transition-colors">
          <input type="radio" name="export-format" value="excel" class="radio radio-primary mr-4">
          <div class="flex-1">
            <div class="flex items-center">
              <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-2 text-accent"></i>
              <span class="font-semibold">Excel</span>
            </div>
            <p class="text-sm text-base-content/70 mt-1">
              Arquivo Excel com múltiplas abas e formatação avançada
            </p>
          </div>
        </label>
      </div>

      <!-- Export Info -->
      <div class="bg-info/10 border border-info/20 rounded-lg p-3">
        <div class="flex items-start">
          <i data-lucide="info" class="w-4 h-4 mr-2 text-info mt-0.5"></i>
          <div class="text-sm">
            <p class="font-medium text-info">Informações do Export:</p>
            <ul class="text-base-content/70 mt-1 space-y-1">
              <li>• Todas as suas categorias, gastos e receitas serão incluídos</li>
              <li>• Os dados são organizados por tipo para facilitar a análise</li>
              <li>• O arquivo será baixado automaticamente após a seleção</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-action">
      <button class="btn" onclick="closeExportModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="executeExport()">
        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
        Exportar Dados
      </button>
    </div>
  </div>
</div>

<script type="text/javascript" src="{% static 'js/finance_dashboard.js' %}"></script>
{% endblock %}

